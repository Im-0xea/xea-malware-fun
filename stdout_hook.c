#include <stddef.h>
#include <string.h>
#include <dlfcn.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>

#define HOOK_FILE "/tmp/stdout_hook.log"

static ssize_t (*original_write)(int fd, const void * buf, size_t count) = NULL;

ssize_t write(int fd, const void * buf, size_t count)
{
	if (original_write == NULL) original_write = dlsym(RTLD_NEXT, "write");
	
	const ssize_t ret = original_write(fd, buf, count);
	if (fd == 1 || fd == 2 //&& isatty(0)
		   ) {
		const int hook_fd = open(HOOK_FILE, O_WRONLY | O_APPEND | O_CREAT, 0644);
		if (hook_fd != -1) {
			write(hook_fd, buf, strlen(buf));
			close(hook_fd);
		}
	}
	return ret;
}
