#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>

#define PAGE_SIZE 4096

/* DO NOT TOUCH! - set in Makefile */
#define PAYLOAD_FUNCTION_OFFSET 0x00000000000013a9

static __attribute__((always_inline)) inline void n(void) {
	asm volatile("nop");
}

void exec_payload(void);

const char payload[] = "\x48\xc7\xc7\x02\x00\x00\x00\x48\xc7\xc0\x3c\x00\x00\x00\x0f\x05";

int main(const int c, char ** v, char ** e)
{
	(void) c;
	int new_fd, exe_fd, rb;
	char buf[PAGE_SIZE];
	
	exec_payload();
	
	if ((new_fd = open("/tmp/sm.elf", O_WRONLY | O_CREAT, 00700)) == -1) return 1;
	
	if ((exe_fd = open("/proc/self/exe", O_RDONLY)) <= 0) goto exe_error;
	
	printf("%d %d\n", new_fd, exe_fd);
	while ((rb = read(exe_fd, buf, PAGE_SIZE)) > 0) {
		printf("made it\n");
		write(new_fd, buf, rb);
	}
	
	close(exe_fd);
	
	if (lseek(new_fd, PAYLOAD_FUNCTION_OFFSET + 20, SEEK_SET) == -1) goto exe_error;
	
	if (write(new_fd, payload, sizeof(payload)) <= 0) goto exe_error;
	
	close(new_fd);
	
	execve("/tmp/sm.elf", v, e);
	
	puts("reexec failed\n");
	
	exe_error:
	close(new_fd);
	return 1;
}

// thats right!!!, 256 volatile nop instructions >:3
__attribute__((noinline)) void exec_payload(void) {
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
}
