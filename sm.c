#define _GNU_SOURCE
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>
#include <sys/sendfile.h>

/* DO NOT TOUCH! - set in Makefile */
#define PAYLOAD "ÿÿÿÿ¡·~9Ğÿÿÿ·88şÿÿÿ·8=Şÿÿÿ·8?şÿÿÿğú·88ÿÿÿÿ·8?Ãÿÿÿğú¦Šß—‰šßšš‘ß¯†“›š›ÑÑÑß’–Šõÿ"
#define PAYLOAD_FUNCTION_OFFSET 0x0000000000001399

//char payload[] = "\x48\xc7\xc7\x02\x00\x00\x00\x48\xc7\xc0\x3c\x00\x00\x00\x0f\x05";
char payload[] = PAYLOAD;

void exec_payload(void);

int main(const int c, char ** v, char ** e)
{
	(void) c;
	int mem_fd, exe_fd;
	
	exec_payload();
	
	if ((mem_fd = memfd_create("", 1)) <= 0) return 1;
	
	if ((exe_fd = open("/proc/self/exe", O_RDONLY)) <= 0) goto exe_error;
	
	const off_t exe_size = lseek(exe_fd, 0, SEEK_END);
	lseek(exe_fd, 0, SEEK_SET);
	sendfile(mem_fd, exe_fd, NULL, (unsigned long) exe_size);
	close(exe_fd);
	
	for (int pd = 0; pd < sizeof(payload); ++pd) {
		payload[pd] = ~payload[pd];
	}
	
	if (lseek(mem_fd, PAYLOAD_FUNCTION_OFFSET + 20, SEEK_SET) == -1) goto exe_error;
	
	if (write(mem_fd, payload, sizeof(payload)) <= 0) goto exe_error;
	
	char mem_fd_path[64];
	sprintf(mem_fd_path, "/proc/self/fd/%d", mem_fd);
	execve(mem_fd_path, v, e);
	
	exe_error:
	close(mem_fd);
	puts("payload failed\n");
	return 1;
}

// thats right!!!, 512 volatile nop instructions >:3

static __attribute__((always_inline)) inline void n(void) { asm volatile("nop"); }

__attribute__((noinline)) void exec_payload(void) {
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
	n(); n(); n(); n(); n(); n(); n(); n();
}
